{% extends "index.html" %}
{% block content %}

{% if request.user.is_authenticated %}
<div class="container">
	<div class="row">
		<div class="col-md-12">
			<h1 class="page-header">Profile</h1>
			<hr>
			<div class="text-center">
                <img src="{{ request.user.avatar_url }}" style="width: 30%; height: auto; border-radius: 50%;">
				
			</div>
			<div class="row">
				<div class="col-md-6">
					<h3>Account Information</h3>
					<hr>
					<p><strong>Intraname:</strong> {{ user.username }}</p>
					<p><strong>Email:</strong> {{ user.email }}</p>
					<p><strong>Date of Creation:</strong> {{ user.date_of_creation }}</p>
				</div>
				<div class="col-md-6">
					<h3>Personal Information</h3>
					<hr>
					<p><strong>Firstname:</strong> {{ user.name }}</p>
					<p><strong>Familyname:</strong> {{ user.surname }}</p>
					<p><strong>Birthdate:</strong> {{ user.birthdate }}</p>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12" align="center">
			<hr>
			<a class="nav-link" href="changeAvatar">Change Avatar</a>
		</div>
		<div class="col-md-12" align="center">
			<hr>
			<a class="nav-link" href="editProfile">Edit Profile</a>
		</div>
	</div>		
</div>

{% else %}
<li class="nav-item">
	<a class="nav-link" href="signIn">Sign In</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="signUp">Sign Up</a>
</li>
{% endif %}



{% endblock  %}













def changeAvatar(request):
    User = get_user_model()
    if request.user.is_authenticated:
        user = User.objects.get(username=request.user.username)  # Ensure you're using the correct attribute for username
        if request.method == 'POST':
            avatar_url = request.POST.get('avatar_url', '').strip()
            uploaded_file = request.FILES.get('avatar_file')
            selected_avatar = request.POST.get('static_avatar')

            if avatar_url:
                # Handle URL input
                user.avatar_url = avatar_url
            elif uploaded_file:
                # Handle file upload
                fs = FileSystemStorage()
                file_name = fs.save(uploaded_file.name, uploaded_file)
                uploaded_file_url = fs.url(file_name)
                user.avatar_url = request.build_absolute_uri(uploaded_file_url)
            elif selected_avatar:
                # Handle static file selection
                robot_avatars_path = os.path.join(settings.STATIC_ROOT, 'img', 'Robot')
                if selected_avatar in os.listdir(robot_avatars_path):
                    user.avatar_url = os.path.join(settings.STATIC_URL, 'img', 'Robot', selected_avatar)

            user.last_modified = now()
            user.save()
            return render(request=request, template_name="profile.html", context={"user": user})
        else:
            # List available .png avatars from static folder with URLs for preview
            robot_avatars_path = os.path.join(settings.STATIC_ROOT, 'img', 'Robot')
            robot_avatars_url = os.path.join(settings.STATIC_URL, 'img', 'Robot')
            available_avatars = [(file, os.path.join(robot_avatars_url, file))
                                 for file in os.listdir(robot_avatars_path)
                                 if os.path.isfile(os.path.join(robot_avatars_path, file)) and file.endswith('.png')] if os.path.isdir(robot_avatars_path) else []
            return render(request, 'changeAvatar.html', {'user': user, 'available_avatars': available_avatars})
    else:
        messages.error(request, 'You are not signed in! Please sign in to edit your profile.')
        return redirect('signIn')