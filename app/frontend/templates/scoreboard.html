{% extends 'index.html' %}
{% load i18n %}
{% block content %}
<div class="container mt-4">
  <h1 class="text-center">{{ request.user.username }}'s stats</h1>
  <div class="row">
    <div class="col-md-6 offset-md-3">
      <ul class="list-group" id="game-list">
        <p style="padding-top: 1em">{% trans "Pong:" %}</p>
        <li class="list-group-item">{% trans "Games Played:" %} {{ games_played_pong}}</li>
        <li class="list-group-item">{% trans "Games Won:" %} {{ games_won_pong }}</li>
        <li class="list-group-item">{% trans "Win Streak:" %} {{ pong_max_win_streak }}</li>
        <p style="padding-top: 1em">{% trans "Memory:" %}</p>
        <li class="list-group-item">{% trans "Games Played:" %} {{games_played_memory}}</li>
        <li class="list-group-item">{% trans "Games Won:" %} {{games_won_memory}}</li>
        <li class="list-group-item">{% trans "Win Streak:" %} {{memory_max_win_streak}}</li>
      </ul>
      <div class="btn-group mb-3" role="group">
        <button id="filter-pong" class="btn btn-primary">Pong Stats</button>
        <button id="filter-memory" class="btn btn-primary">Memory Stats</button>
        <button id="filter-all" class="btn btn-primary">All</button>
      </div>
      <ul class="list-group" id="game-list">
        <li class="list-group-item active">Historic:</li>
        {% for game in all_games %}
        <li class="list-group-item game-item" style="display: none;">
          {{ game.game_date }} - Game:
          {% if game.pong_game %}
          Pong
          {% elif game.memory_game %}
          Memory
          {% endif %}
          - Type:
          {% if game.is_tournament %}
          Tournament
          {% else %}
          1vs1
          {% endif %}
          - Players:
          {% for participant in game.participants.all %}
          {{ participant.display_name }}{% if not forloop.last %} vs {% endif %}
          {% endfor %}
          - Winner: {{ game.winner.display_name }} - Score: {{ game.score_winner }} - {{ game.score_loser }}
        </li>
        {% endfor %}
      </ul>
      <nav aria-label="Pagination">
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <button id="prev-page" class="btn btn-primary">Previous</button>
          </li>
          <li class="page-item">
            <button id="next-page" class="btn btn-primary">Next</button>
          </li>
        </ul>
      </nav>
      <div class="text-center">
        <button id="graphs-button" class="btn btn-success">Graphs</button>
      </div>
      <canvas id="gamesChart" width="400" height="200"></canvas> <!-- Canvas for chart -->
    </div>
  </div>
</div>
<script>

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrfToken = getCookie('csrftoken');

  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM fully loaded and parsed");
    const gameItems = document.querySelectorAll('.game-item');
    let currentPage = 0;
    const itemsPerPage = 5;
    let type = undefined;

    function showPage(page, type) {
      for (let i = 0; i < gameItems.length; i++) {
        if (i >= page * itemsPerPage && i < (page + 1) * itemsPerPage && (type === undefined || gameItems[i].innerText.includes(type))) {
          gameItems[i].style.display = 'block';
        } else {
          gameItems[i].style.display = 'none';
        }
      }
    }

    document.getElementById('next-page').addEventListener('click', function () {
      if ((currentPage + 1) * itemsPerPage < gameItems.length) {
        currentPage++;
        showPage(currentPage, type);
      }
    });

    document.getElementById('prev-page').addEventListener('click', function () {
      if (currentPage > 0) {
        currentPage--;
        showPage(currentPage, type);
      }
    });

    document.getElementById('filter-pong').addEventListener('click', function () {
      currentPage = 0;
      type = 'Pong';
      showPage(currentPage, type);
    });

    document.getElementById('filter-memory').addEventListener('click', function () {
      currentPage = 0;
      type = 'Memory';
      showPage(currentPage, type);
    });

    document.getElementById('filter-all').addEventListener('click', function () {
      currentPage = 0;
      type = undefined;
      showPage(currentPage, type);
    });

    fetch('/get_user_statistics/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
      .then(response => response.json())
      .then(data => {
        console.log('Data received from server:', data); // Debugging statement
        // Process the data and generate the chart
        generateGamesPlayedChart(data);
      })
      .catch(error => {
        console.error('Error fetching games data:', error);
      });

    function generateGamesPlayedChart(data) {
      console.log('Structure of a single game object:', data.games_data[0]); // Debugging statement

      const canvas = document.getElementById('gamesChart');
      const ctx = canvas.getContext('2d');

      // Extract relevant data for the chart
      const dates = data.map(game => game.game_date);
      const gamesPlayed = data.map(game => game.games_played);

      // Draw chart
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Games Played',
            data: gamesPlayed,
            borderColor: 'blue',
            backgroundColor: 'rgba(0, 0, 255, 0.2)',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Number of Games Played'
              }
            }
          }
        }
      });
    }
    showPage(currentPage, type);
  });
</script>
{% endblock %}
{% block footer %}
{# Leave the footer block empty to exclude the footer #}
{% endblock %}